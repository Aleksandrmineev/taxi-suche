<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bestell-Suche</title>
    <style>
      :root {
        --bg: #0b0f14;
        --card: #121821;
        --text: #e6eef7;
        --muted: #a8b3c5;
        --accent: #4da3ff;
        --green: #35d07f;
        --radius: 16px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 500 16px/1.45 system-ui;
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .card {
        width: min(820px, 100%);
        background: var(--card);
        border-radius: var(--radius);
        padding: 50px 24px 24px;
        position: relative;
      }
      h1 {
        margin: 0 0 12px;
        text-align: center;
      }
      .btn-add {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10;

        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 10px;

        font-size: 15px;
        font-weight: 600;
        padding: 8px 14px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transition: transform 0.15s ease, filter 0.15s ease;
      }
      .btn-add:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
      }
      .btn-add:active {
        transform: translateY(0);
      }

      .search {
        display: grid;
        gap: 12px;
        justify-items: center;
        margin: 10px 0 18px;
        width: min(520px, 100%);
        margin-inline: auto;
      }
      .input-wrap {
        position: relative;
        width: 100%;
      }
      #q {
        width: 100%;
        font: 600 20px/1.2 system-ui;
        color: var(--text);
        text-align: center;
        background: #0e141c;
        border: 1px solid #1b2738;
        border-radius: 12px;
        padding: 12px 48px 12px 14px;
        outline: none;
      }
      #q:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(77, 163, 255, 0.15);
      }
      .clear-btn {
        position: absolute;
        inset-inline-end: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: grid;
        place-items: center;
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 1px solid #1b2738;
        background: #0e141c;
        cursor: pointer;
        padding: 0;
      }
      .clear-btn svg {
        width: 16px;
        height: 16px;
        opacity: 0.8;
        color: var(--text);
        stroke: currentColor;
        pointer-events: none;
      }
      .muted {
        color: var(--muted);
      }
      ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 10px;
      }
      li {
        border: 1px solid #1b2738;
        border-radius: 12px;
        padding: 12px 14px;
        cursor: pointer;
        transition: background 0.12s ease, transform 0.05s ease;
      }
      li:hover {
        background: #0f1620;
      }
      li:active {
        transform: scale(0.99);
      }
      li.copied {
        color: var(--green);
        border-color: rgba(53, 208, 127, 0.5);
        background: rgba(53, 208, 127, 0.06);
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
      }
      .row small {
        color: var(--muted);
      }
      .addr {
        opacity: 0.95;
        max-width: 80%;
      }
      mark {
        background: none;
        color: var(--accent);
        font-weight: 700;
      }
      .toast {
        position: fixed;
        background: #0e141c;
        border: 1px solid #1b2738;
        color: #e6eef7;
        padding: 8px 10px;
        border-radius: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease;
        transform: translate(-50%, -120%);
        font-size: 14px;
      }
      .toast.show {
        opacity: 1;
      }
      .recent {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-bottom: 12px;
      }
      .recent button {
        background: #1b2738;
        color: var(--muted);
        border: 0;
        border-radius: 6px;
        padding: 4px 10px;
        cursor: pointer;
        font-size: 14px;
      }
      .recent button:hover {
        color: var(--text);
      }
      /* modal */
      dialog {
        background: #0e141c;
        border: 1px solid #1b2738;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: clamp(280px, 90vw, 400px);
        inset: 0;
        margin: auto;
        color: var(--text);
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
      }
      dialog input,
      dialog textarea {
        width: 100%;
        margin: 8px 0 16px;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #1b2738;
        background: #121821;
        color: var(--text);
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .btn {
        padding: 6px 12px;
        border: 0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-save {
        background: var(--green);
        color: #fff;
      }
      .btn-cancel {
        background: #444;
        color: #fff;
      }

      /* Отключаем авто-зум iOS: шрифт >= 16px для форм в модалке */
      dialog input,
      dialog textarea {
        font: 600 18px/1.3 system-ui; /* можно 20px для полного совпадения с #q */
      }

      /* Твоя стилизация — оставил и дополнил */
      dialog input,
      dialog textarea {
        width: 100%;
        margin: 8px 0 16px;
        padding: 10px 12px; /* чуть удобнее под палец */
        border-radius: 8px; /* чуток больше радиус для единообразия */
        border: 1px solid #1b2738;
        background: #121821;
        color: var(--text);
        outline: none;
      }

      dialog input:focus,
      dialog textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px rgba(77, 163, 255, 0.15);
      }

      /* Сам диалог — адаптив и прокрутка внутри при маленьких экранах */
      dialog {
        background: #0e141c;
        border: 1px solid #1b2738;
        border-radius: 12px;
        padding: 20px;
        max-width: 420px;
        width: clamp(280px, 90vw, 420px);
        max-height: 90dvh;
        overflow: auto;
      }

      /* На iOS дополнительно форсируем 18px на интерактивных элементах */
      @supports (-webkit-touch-callout: none) {
        input,
        select,
        textarea,
        button {
          font-size: 18px;
        }
      }

      /* Ровные скроллбары в textarea (не обязательно) */
      dialog textarea {
        resize: vertical;
        min-height: 84px; /* близко к 3 строкам при 18px */
      }

      /* WhatsApp кнопка в строке результата */
      .btn-wa {
        margin-left: auto;
        background: #1b8d3f;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 4px 10px;
        font-size: 13px;
        cursor: pointer;
      }
      .btn-wa:hover {
        filter: brightness(1.06);
      }

      /* Попап выбора водителя */
      .drivers-popup {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1000;
      }
      .drivers-popup__inner {
        background: #0e141c;
        border: 1px solid #1b2738;
        color: #e6eef7;
        border-radius: 12px;
        padding: 16px;
        width: min(360px, 92vw);
      }
      .drivers-popup__title {
        margin: 0 0 10px;
        font-weight: 700;
      }
      .drivers-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .drivers-list .wa-driver {
        background: #1b2738;
        color: #e6eef7;
        border: 0;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .drivers-list .wa-driver:hover {
        filter: brightness(1.08);
      }
      .drivers-popup__actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
      }
      .drivers-popup__close {
        background: #444;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
      }

      /* Кнопка "Смена" рядом с + Neuer Auftrag */
      .btn-shift {
        position: fixed;
        top: 20px;
        left: 25px;
        z-index: 10;
        background: #2b3b52;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        padding: 8px 14px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transition: transform 0.15s ease, filter 0.15s ease;
      }
      .btn-shift:hover {
        filter: brightness(1.05);
        transform: translateY(-2px);
      }
      .btn-shift:active {
        transform: translateY(0);
      }

      /* Диалог настройки активных */
      .shift-popup {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1100;
      }
      .shift-popup__inner {
        background: #0e141c;
        border: 1px solid #1b2738;
        color: #e6eef7;
        border-radius: 12px;
        padding: 16px;
        width: min(420px, 92vw);
        max-height: 90dvh;
        overflow: auto;
      }
      .shift-title {
        margin: 0 0 10px;
        font-weight: 700;
      }
      .shift-list {
        display: grid;
        gap: 8px;
      }
      .shift-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .shift-row input {
        accent-color: #4da3ff;
      }
      .shift-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      .shift-btn {
        background: #444;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .shift-btn--save {
        background: #35d07f;
      }

      /* Попап выбора водителя — добавим хинт, если активных нет */
      .drivers-popup__hint {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 14px;
      }
      .drivers-popup__footer {
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
      }
      .drivers-popup__small {
        font-size: 13px;
        color: var(--muted);
      }
      .drivers-popup__link {
        background: #2b3b52;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        margin-bottom: 5px;
      }

      .btn-log {
        position: fixed;
        top: 20px;
        left: 110px;
        z-index: 10;
        background: #2b3b52;
        color: #fff;
        border: 0;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        padding: 8px 14px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transition: 0.15s;
      }
      .btn-log:hover {
        filter: brightness(1.05);
        transform: translateY(-2px);
      }
      .btn-log:active {
        transform: translateY(0);
      }

      /* Диалог лога */
      .log-popup {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(0, 0, 0, 0.45);
        z-index: 1200;
      }
      .log-popup__inner {
        background: #0e141c;
        border: 1px solid #1b2738;
        color: #e6eef7;
        border-radius: 12px;
        width: min(800px, 94vw);
        max-height: 90dvh;
        padding: 16px;
        overflow: auto;
      }
      .log-head {
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .log-actions {
        display: flex;
        gap: 8px;
      }
      .log-btn {
        background: #2b3b52;
        color: #fff;
        border: 0;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .log-btn--danger {
        background: #7a2b2b;
      }
      .log-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      .log-table th,
      .log-table td {
        border-bottom: 1px solid #1b2738;
        padding: 8px 6px;
        vertical-align: top;
      }
      .log-table th {
        text-align: left;
        color: #a8b3c5;
        font-weight: 600;
      }
      .log-empty {
        color: #a8b3c5;
        padding: 12px 0;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>Suche nach Telefon</h1>
      <button class="btn-add" id="btnAdd">+ Neuer Auftrag</button>
      <button class="btn-shift" id="btnShift">Schicht</button>
      <button class="btn-log" id="btnLog">Protokoll</button>

      <div class="search">
        <div class="input-wrap">
          <input
            id="q"
            placeholder="Nur Ziffern eingeben…"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <button
            id="clear"
            class="clear-btn"
            aria-label="Eingabe löschen"
            type="button"
          >
            <svg viewBox="0 0 24 24">
              <path
                d="M18 6L6 18M6 6l12 12"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
            </svg>
          </button>
        </div>
        <div class="recent" id="recent"></div>
        <p class="muted" id="hint">
          Geben Sie einige Ziffern der Telefonnummer ein.
        </p>
      </div>

      <ul id="list"></ul>
    </main>

    <div id="toast" class="toast">Kopiert</div>

    <!-- Modal Add New -->
    <dialog id="dlg">
      <h3>Neuer Auftrag</h3>

      <!-- Только цифры: digits-only клавиатура на iOS/Android -->
      <input
        id="newPhone"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        autocomplete="tel"
        placeholder="Telefonnummer"
      />

      <!-- Адрес на 3 строки -->
      <textarea id="newAddr" rows="3" placeholder="Adresse"></textarea>

      <div class="modal-buttons">
        <button class="btn btn-cancel" id="cancelAdd">Abbrechen</button>
        <button class="btn btn-save" id="saveAdd">Speichern</button>
      </div>
    </dialog>

    <script>
      const listEl = document.getElementById("list");
      const q = document.getElementById("q");
      const hint = document.getElementById("hint");
      const clearBtn = document.getElementById("clear");
      const toast = document.getElementById("toast");
      const recentEl = document.getElementById("recent");
      const dlg = document.getElementById("dlg");
      const newPhone = document.getElementById("newPhone");
      const newAddr = document.getElementById("newAddr");

      let data = [];
      let lastTap = 0;

      const normalizeDigits = (s) => (s || "").replace(/\D+/g, "");
      const ls = {
        get(key, def) {
          try {
            return JSON.parse(localStorage.getItem(key)) || def;
          } catch {
            return def;
          }
        },
        set(key, val) {
          localStorage.setItem(key, JSON.stringify(val));
        },
      };
      /* === Список водителей: отредактируй номера/имена под себя === */
      const drivers = JSON.parse(
        localStorage.getItem("driversList") || "null"
      ) || [
        { name: "Aleks", phone: "4368181289405" },
        { name: "Berti", phone: "4367763113438" },
        { name: "Gabi", phone: "436506367662" },
        { name: "Günter", phone: "436641660694" },
        { name: "Michael", phone: "436503781007" },
        { name: "Sascha", phone: "436765654250" },
      ];

      /* Сохранить кастомный список (если потом захочешь редактировать из кода) */
      function saveDriversList(list) {
        localStorage.setItem("driversList", JSON.stringify(list));
      }

      /* ===== Активные на смене (по дням) ===== */

      /* Устойчивый ID водителя по номеру (только цифры) */
      const driverId = (d) => (d.phone || "").replace(/\D+/g, "");

      /* Сегодняшний ключ yyyy-mm-dd по локальному времени (Вена/Австрия) */
      function todayKey() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      /* Хранилище: { "2025-10-11": ["43664...","43665..."], ... } */
      const ACTIVE_STORE_KEY = "activeDriversByDate";

      function loadActiveMap() {
        try {
          return JSON.parse(localStorage.getItem(ACTIVE_STORE_KEY)) || {};
        } catch {
          return {};
        }
      }
      function saveActiveMap(map) {
        localStorage.setItem(ACTIVE_STORE_KEY, JSON.stringify(map));
      }

      function getTodayActiveIds() {
        const map = loadActiveMap();
        return new Set(map[todayKey()] || []);
      }
      function setTodayActiveIds(idArray) {
        const map = loadActiveMap();
        map[todayKey()] = Array.from(new Set(idArray));
        saveActiveMap(map);
      }

      function isDriverActiveToday(d) {
        const ids = getTodayActiveIds();
        return ids.has(driverId(d));
      }

      /* Если на сегодня ничего не отмечено — умолчание: ВСЕ активны (можно поменять на пусто) */
      function ensureTodayDefaults() {
        const map = loadActiveMap();
        const key = todayKey();
        if (!map[key]) {
          map[key] = drivers.map((d) => driverId(d)); // по умолчанию все
          saveActiveMap(map);
        }
      }

      /* UI: диалог выбора активных */
      function showShiftDialog() {
        const activeSet = getTodayActiveIds();
        const wrap = document.createElement("div");
        wrap.className = "shift-popup";
        wrap.innerHTML = `
    <div class="shift-popup__inner">
      <p class="shift-title">Aktive Fahrer — ${todayKey()}</p>
      <div class="shift-list">
        ${drivers
          .map((d) => {
            const id = driverId(d);
            const checked = activeSet.has(id) ? "checked" : "";
            return `
            <label class="shift-row">
              <input type="checkbox" value="${id}" ${checked}>
              <span>${d.name} — ${d.phone}</span>
            </label>
          `;
          })
          .join("")}
      </div>
      <div class="shift-actions">
        <button class="shift-btn" data-act="none">Keiner</button>
        <button class="shift-btn" data-act="all">Alle</button>
        <button class="shift-btn shift-btn--save" data-act="save">Speichern</button>
        <button class="shift-btn" data-act="close">Schließen</button>
      </div>
    </div>
  `;
        document.body.appendChild(wrap);

        const inner = wrap.querySelector(".shift-popup__inner");
        const checkboxes = Array.from(
          inner.querySelectorAll('input[type="checkbox"]')
        );

        inner.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (!act) return;

          if (act === "all") {
            checkboxes.forEach((cb) => (cb.checked = true));
          } else if (act === "none") {
            checkboxes.forEach((cb) => (cb.checked = false));
          } else if (act === "save") {
            const ids = checkboxes
              .filter((cb) => cb.checked)
              .map((cb) => cb.value);
            setTodayActiveIds(ids);
            wrap.remove();
          } else if (act === "close") {
            wrap.remove();
          }
        });

        wrap.addEventListener("click", (e) => {
          if (e.target === wrap) wrap.remove();
        });
      }

      /* Кнопка "Смена" */
      document
        .getElementById("btnShift")
        .addEventListener("click", showShiftDialog);

      /* При загрузке — обеспечить умолчание на сегодня */
      ensureTodayDefaults();

      /* Открыть WA на конкретный номер с готовым текстом */
      function sendToDriverPhone(phoneDigits, text) {
        const link = `https://wa.me/${phoneDigits}?text=${encodeURIComponent(
          text
        )}`;

        const ua = navigator.userAgent || "";
        const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
        const isIOS =
          /iP(hone|ad|od)/.test(ua) ||
          (ua.includes("Mac") && "ontouchend" in document);

        // 📱 Мобильные: просто переход по ссылке — WhatsApp перехватывает и открывает приложение
        if (isMobile || isIOS) {
          window.location.href = link;
          return;
        }

        // 💻 Десктоп: открываем временный popup и закрываем его автоматически
        const w = window.open("about:blank", "_blank");

        if (w) {
          try {
            w.location.replace(link);
          } catch (e) {
            try {
              w.location.href = link;
            } catch (err) {
              console.warn("Der Link konnte nicht geöffnet werden:", err);
            }
          }

          // Закрываем popup через 3 секунды
          setTimeout(() => {
            try {
              w.close();
            } catch (e) {}
          }, 3000);
        } else {
          // fallback: если popup заблокирован, открываем напрямую
          window.location.href = link;
        }
      }

      /* Попап выбора водителя */
      function showDriversPopup(textToSend) {
        const activeIds = getTodayActiveIds();
        const activeDrivers = drivers.filter((d) => activeIds.has(driverId(d)));

        const showing = activeDrivers.length ? activeDrivers : drivers; // если активных нет, покажем всех
        const hint = activeDrivers.length
          ? ""
          : `<div class="drivers-popup__hint">Für heute sind keine aktiven Fahrer markiert – zeige alle.</div>`;

        const wrap = document.createElement("div");
        wrap.className = "drivers-popup";
        wrap.innerHTML = `
    <div class="drivers-popup__inner">
      <p class="drivers-popup__title">An WhatsApp senden:</p>
      ${hint}
      <div class="drivers-list">
        ${showing
          .map(
            (d, i) =>
              `<button class="wa-driver" data-id="${driverId(d)}">${
                d.name
              }</button>`
          )
          .join("")}
      </div>
      <div class="drivers-popup__footer">
        <span class="drivers-popup__small">${
          activeDrivers.length ? "Heutige aktive Fahrer" : "Alle Fahrer"
        }</span>
        <div>
          <button class="drivers-popup__link" data-act="shift">Ändern</button>
          <button class="drivers-popup__close" type="button">Schließen</button>
        </div>
      </div>
    </div>
  `;
        wrap.querySelectorAll(".wa-driver").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const d = drivers.find((v) => driverId(v) === id);
            const driverPhone = driverId(d);
            const line = textToSend; // уже сформированный текст (тел+адрес)
            // Источник (из текущего выбранного элемента)
            const srcPhone = (q.value || "").replace(/\D+/g, "");
            const srcAddr = ""; // если хочешь, передай сюда address из render-конекста

            // ⚠️ ЛОГ: фиксируем факт отправки (открытия WA)
            addLog({
              driverName: d?.name || "",
              driverPhone,
              text: line,
              srcPhone,
              srcAddr,
              method: "WhatsApp",
            });

            sendToDriverPhone(driverPhone, line);
            wrap.remove();
          });
        });

        document.body.appendChild(wrap);

        wrap.querySelectorAll(".wa-driver").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const d = drivers.find((v) => driverId(v) === id);
            sendToDriverPhone(driverId(d), textToSend);
            wrap.remove();
          });
        });

        wrap
          .querySelector(".drivers-popup__close")
          .addEventListener("click", () => wrap.remove());
        wrap.addEventListener("click", (e) => {
          if (e.target === wrap) wrap.remove();
        });

        wrap
          .querySelector('[data-act="shift"]')
          .addEventListener("click", () => {
            wrap.remove();
            showShiftDialog();
          });
      }

      function safeDateStr(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return isNaN(d) ? "" : d.toLocaleString("de-AT");
      }

      function showToastAt(x, y, text = "Kopiert") {
        toast.textContent = text;
        toast.style.left = x + "px";
        toast.style.top = y + "px";
        toast.classList.add("show");
        clearTimeout(showToastAt._t);
        showToastAt._t = setTimeout(() => toast.classList.remove("show"), 900);
      }
      function getEventXY(evt) {
        if (evt.touches && evt.touches[0])
          return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
        if (evt.changedTouches && evt.changedTouches[0])
          return {
            x: evt.changedTouches[0].clientX,
            y: evt.changedTouches[0].clientY,
          };
        return { x: evt.clientX, y: evt.clientY };
      }
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
        } catch {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }
      }

      function highlightDigits(phone, digits) {
        if (!digits) return phone;
        const re = new RegExp(`(${digits})`, "g");
        return phone.replace(re, "<mark>$1</mark>");
      }

      function render(items) {
        listEl.innerHTML = "";
        for (const item of items) {
          const li = document.createElement("li");
          const phone = item.phone_e164 || item.phone_raw || "";
          const digits = normalizeDigits(q.value);
          const phoneHTML = highlightDigits(phone, digits);
          const dateStr = safeDateStr(item.timestamp_iso);
          const address = item.address || "";

          li.innerHTML = `
      <div class="row">
        <strong>${phoneHTML}</strong>
        ${dateStr ? `<small>${dateStr}</small>` : ""}
        <div class="addr">${address}</div>
        <button class="btn-wa" title="В WhatsApp" type="button">WA</button>
      </div>
    `;

          // 1) Клик по карточке — копирование в буфер
          li.addEventListener("click", (ev) => {
            const line = address ? `${phone} ${address}` : `${phone}`;
            copyToClipboard(line.trim());
            li.classList.add("copied");
            setTimeout(() => li.classList.remove("copied"), 1200);
            const { x, y } = getEventXY(ev);
            showToastAt(x, y, "Kopiert");
          });

          // 2) Кнопка WA — не копируем, открываем попап выбора водителя
          li.querySelector(".btn-wa").addEventListener("click", (ev) => {
            ev.stopPropagation();
            const line = address ? `${phone} ${address}` : `${phone}`;
            // Передаем и сам адрес
            showDriversPopup(line.trim(), {
              srcPhone: phone,
              srcAddr: address,
            });
          });

          listEl.appendChild(li);
        }
      }

      async function load() {
        try {
          const res = await fetch("data.json", { cache: "no-store" });
          data = await res.json();
          const extra = ls.get("customOrders", []);
          data = data.concat(extra);
          data.sort((a, b) => {
            const da = a.timestamp_iso
              ? new Date(a.timestamp_iso).getTime()
              : -Infinity;
            const db = b.timestamp_iso
              ? new Date(b.timestamp_iso).getTime()
              : -Infinity;
            return db - da;
          });
          render([]);
          q.focus(); // автофокус
        } catch (e) {
          hint.textContent = "Fehler beim Laden (" + e.message + ")";
        }
        renderRecents();
      }

      function update() {
        const digits = normalizeDigits(q.value);
        if (!digits) {
          render([]);
          hint.textContent = "Geben Sie einige Ziffern ein.";
          return;
        }
        let recents = ls.get("recentSearches", []);
        if (!recents.includes(digits)) {
          recents.unshift(digits);
          if (recents.length > 10) recents.pop();
          ls.set("recentSearches", recents);
        }
        renderRecents();
        const out = [];
        for (const r of data) {
          const phoneDigits =
            r.phone_digits ||
            normalizeDigits(r.phone_raw || r.phone_e164 || "");
          if (phoneDigits.includes(digits)) out.push(r);
          if (out.length >= 50) break;
        }
        render(out.slice(0, 10));
        hint.textContent = out.length
          ? `Gefunden: ${out.length} (zeige 10)`
          : "Keine Treffer";
      }

      function renderRecents() {
        const rec = ls.get("recentSearches", []);
        recentEl.innerHTML = "";
        for (const d of rec) {
          const b = document.createElement("button");
          b.textContent = d;
          b.addEventListener("click", () => {
            q.value = d;
            update();
          });
          recentEl.appendChild(b);
        }
      }
      q.addEventListener("click", () => {
        const now = Date.now();
        if (now - lastTap < 400) {
          q.value = "";
          update();
          setTimeout(() => q.focus(), 0);
        } else {
          q.select();
        }
        lastTap = now;
      });
      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        q.value = "";
        update();
        setTimeout(() => q.focus(), 0);
      });
      let inputTimer;
      q.addEventListener("input", () => {
        clearTimeout(inputTimer);
        inputTimer = setTimeout(() => update(), 1000); // задержка 0.5 сек
      });
      document.getElementById("btnAdd").addEventListener("click", () => {
        dlg.showModal();
        newPhone.value = "";
        newAddr.value = "";
        newPhone.focus();
      });
      document
        .getElementById("cancelAdd")
        .addEventListener("click", () => dlg.close());
      document.getElementById("saveAdd").addEventListener("click", () => {
        const ph = newPhone.value.trim(),
          addr = newAddr.value.trim();
        if (!ph || !addr) {
          alert("Telefon und Adresse eingeben");
          return;
        }
        const now = new Date();
        const rec = {
          timestamp_iso: now.toISOString(),
          author: "user",
          phone_raw: ph,
          phone_digits: normalizeDigits(ph),
          phone_e164: ph,
          address: addr,
          source_line: -1,
        };
        const all = ls.get("customOrders", []);
        all.push(rec);
        ls.set("customOrders", all);
        data.unshift(rec);
        dlg.close();
        update();
        showToastAt(window.innerWidth / 2, 40, "Gespeichert");
      });

      /* ==== WhatsApp Send Log ==== */
      const LOG_KEY = "waSendLog";

      function getLogs() {
        try {
          return JSON.parse(localStorage.getItem(LOG_KEY)) || [];
        } catch {
          return [];
        }
      }
      function saveLogs(arr) {
        localStorage.setItem(LOG_KEY, JSON.stringify(arr));
      }

      /** Добавить запись
       *  payload: { ts, driverName, driverPhone, text, srcPhone, srcAddr, method }
       */
      function addLog(payload) {
        const arr = getLogs();
        arr.unshift({
          ts: payload.ts || new Date().toISOString(),
          driverName: payload.driverName || "",
          driverPhone: (payload.driverPhone || "").replace(/\D+/g, ""),
          text: payload.text || "",
          srcPhone: (payload.srcPhone || "").replace(/\D+/g, ""),
          srcAddr: payload.srcAddr || "",
          method: payload.method || "WhatsApp",
        });
        // опционально ограничим размер
        if (arr.length > 1000) arr.length = 1000;
        saveLogs(arr);
      }

      function fmtAT(iso) {
        const d = new Date(iso);
        return isNaN(d) ? "" : d.toLocaleString("de-AT");
      }

      /* Экспорт в CSV */
      function exportLogsCSV() {
        const rows = getLogs();
        const header = [
          "Zeit",
          "Fahrer",
          "Fahrer-Nr",
          "Quelle-Nr",
          "Adresse",
          "Nachricht",
          "Kanal",
        ];
        const escape = (s) => `"${String(s || "").replace(/"/g, '""')}"`;
        const lines = [header.join(";")].concat(
          rows.map((r) =>
            [
              fmtAT(r.ts),
              r.driverName,
              r.driverPhone,
              r.srcPhone,
              r.srcAddr,
              r.text,
              r.method,
            ]
              .map(escape)
              .join(";")
          )
        );
        const blob = new Blob([lines.join("\n")], {
          type: "text/csv;charset=utf-8",
        });
        const a = document.createElement("a");
        const fn = `protokoll_${new Date().toISOString().slice(0, 10)}.csv`;
        a.href = URL.createObjectURL(blob);
        a.download = fn;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(a.href);
        a.remove();
      }

      /* UI диалог просмотра */
      function showLogDialog() {
        const data = getLogs();
        const wrap = document.createElement("div");
        wrap.className = "log-popup";
        wrap.innerHTML = `
    <div class="log-popup__inner">
      <div class="log-head">
        <strong>Protokoll der gesendeten Nachrichten</strong>
        <div class="log-actions">
          <button class="log-btn" data-act="export">Export CSV</button>
          <button class="log-btn log-btn--danger" data-act="clear">Leeren</button>
          <button class="log-btn" data-act="close">Schließen</button>
        </div>
      </div>
      ${
        data.length
          ? `
      <table class="log-table">
        <thead>
          <tr>
            <th>Zeit</th><th>Fahrer</th><th>Fahrer-Nr</th>
            <th>Quelle-Nr</th><th>Adresse</th><th>Nachricht</th><th>Kanal</th>
          </tr>
        </thead>
        <tbody>
          ${data
            .map(
              (r) => `
            <tr>
              <td>${fmtAT(r.ts)}</td>
              <td>${r.driverName || ""}</td>
              <td>${r.driverPhone || ""}</td>
              <td>${r.srcPhone || ""}</td>
              <td>${r.srcAddr || ""}</td>
              <td>${(r.text || "").replace(/</g, "&lt;")}</td>
              <td>${r.method || "WhatsApp"}</td>
            </tr>
          `
            )
            .join("")}
        </tbody>
      </table>`
          : `<div class="log-empty">Keine Einträge.</div>`
      }
    </div>
  `;
        document.body.appendChild(wrap);

        const inner = wrap.querySelector(".log-popup__inner");
        inner.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (!act) return;
          if (act === "export") exportLogsCSV();
          if (act === "clear") {
            if (confirm("Protokoll wirklich leeren?"))
              saveLogs([]), wrap.remove();
          }
          if (act === "close") wrap.remove();
        });

        wrap.addEventListener("click", (e) => {
          if (e.target === wrap) wrap.remove();
        });
      }

      /* кнопка «Protokoll» */
      document
        .getElementById("btnLog")
        .addEventListener("click", showLogDialog);

      load();
    </script>
  </body>
</html>
